
import { GoogleGenAI } from "@google/genai";

// Assume process.env.API_KEY is configured in the environment
const API_KEY = process.env.API_KEY;

if (!API_KEY) {
  console.warn("API_KEY is not set. AI features will be disabled.");
}

const ai = new GoogleGenAI({ apiKey: API_KEY });

const MANUAL_CONTEXT = `
คุณคือผู้ช่วยอัจฉริยะสำหรับตอบคำถามเกี่ยวกับ "คู่มือการขึ้นทะเบียนและปรับปรุงทะเบียนเกษตรกร ปี 2568" ของกรมส่งเสริมการเกษตร กระทรวงเกษตรและสหกรณ์
หน้าที่ของคุณคือการให้ข้อมูลที่ถูกต้องและเข้าใจง่ายจากเนื้อหาในคู่มือเท่านั้น ห้ามตอบคำถามนอกเหนือจากข้อมูลที่ให้ไว้

สรุปเนื้อหาสำคัญจากคู่มือ:
- วัตถุประสงค์: เพื่อจัดทำฐานข้อมูลเกษตรกรให้ถูกต้อง เป็นปัจจุบัน สำหรับใช้วางแผนนโยบายและให้ความช่วยเหลือจากภาครัฐ
- ผู้มีสิทธิ์: บุคคลธรรมดาและนิติบุคคลที่ประกอบกิจการด้านการเกษตร เช่น ปลูกพืช, ทำนาเกลือ, เพาะเลี้ยงแมลงเศรษฐกิจ
- หลักเกณฑ์สำคัญ: 1 ทะเบียนบ้าน = 1 ครัวเรือนเกษตรกร, คู่สมรสถือเป็นครัวเรือนเดียวกัน
- ขั้นตอน:
  1. ประชาสัมพันธ์ให้เกษตรกรทราบ
  2. เกษตรกรแจ้งความประสงค์พร้อมเอกสาร
  3. เจ้าหน้าที่ตรวจสอบเอกสารและข้อมูล
  4. ตรวจสอบทางสังคม (ติดประกาศ) และตรวจสอบพื้นที่จริง (วาดแปลงดิจิทัล)
  5. พิมพ์ข้อมูลลงสมุดทะเบียนเกษตรกร
- ช่องทาง: สำนักงานเกษตรอำเภอ, แอปพลิเคชัน Farmbook, เว็บไซต์ e-Farmer
- ผู้ช่วยอัจฉริยะ: สามารถตอบคำถามเกี่ยวกับคำศัพท์, คุณสมบัติ, ขั้นตอน, เอกสาร และข้อมูลอื่นๆ ในคู่มือได้
`;

export const getAssistantResponse = async (question: string): Promise<string> => {
  if (!API_KEY) {
    return "ขออภัยค่ะ ขณะนี้ระบบ AI ไม่พร้อมใช้งานเนื่องจากไม่ได้ตั้งค่า API Key";
  }

  try {
    const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash',
        contents: `${MANUAL_CONTEXT}\n\nคำถาม: ${question}`,
        config: {
            systemInstruction: "คุณคือผู้เชี่ยวชาญคู่มือทะเบียนเกษตรกร ตอบคำถามเป็นภาษาไทยให้กระชับและเข้าใจง่าย โดยอ้างอิงจากข้อมูลที่ให้มาเท่านั้น หากไม่พบข้อมูลให้ตอบว่า 'ขออภัยค่ะ ไม่พบข้อมูลเกี่ยวกับเรื่องนี้ในคู่มือ'",
        }
    });
    
    return response.text;

  } catch (error) {
    console.error("Error calling Gemini API:", error);
    return "เกิดข้อผิดพลาดในการสื่อสารกับระบบ AI กรุณาลองใหม่อีกครั้งค่ะ";
  }
};
